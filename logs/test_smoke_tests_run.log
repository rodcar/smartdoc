(.venv) (base) ivan@Ivans-MacBook-Pro smartdoc % python manage.py test tests.test_smartdoc
âœ… Loaded vectordb provider: chromadb
âœ… Loaded embedding provider: chromadb
ğŸš€ Initializing app-level embeddings...
âœ… Using MPS (Apple Silicon GPU) for optimal performance
ğŸ¯ Selected device: mps
âœ… OpenCLIP embedding function initialized successfully
âœ… SentenceTransformer embedding function initialized successfully
âœ… Text: chromadb
âœ… Image: chromadb
ğŸ¯ App embeddings ready
ğŸ“± SmartDoc app ready
Found 6 test(s).
Creating test database for alias 'default'...
System check identified no issues (0 silenced).

ğŸ§ª Integration: Full Workflow
Testing: ti10161552.jpg
ğŸ” Extracting text using OCR service...
ğŸ” Searching for similar documents in vector database...
ğŸ” Debug - Raw text query result: {'success': True, 'results': {'ids': [['6fb5493b-20e8-4d35-ab2b-3b5adfaf5374_txt', '4fad098c-9d10-4d4d-ba42-dc3a94b82bf8_txt', 'd3baecfd-62d5-4f82-8126-0fe683b206a2_txt', '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad_txt', '7704a6b2-ec4d-4dec-8a8e-cb77a0764c3e_txt', '9b416e22-9273-499e-97ee-d16fdb4efd84_txt', 'cedbfb0e-3749-4a45-bdd1-c5e7025802d7_txt']], 'embeddings': None, 'documents': None, 'uris': None, 'included': ['metadatas', 'distances'], 'data': None, 'metadatas': [[{'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374', 'type': 'invoice'}, {'type': 'invoice', 'uuid': '4fad098c-9d10-4d4d-ba42-dc3a94b82bf8'}, {'type': 'invoice', 'uuid': 'd3baecfd-62d5-4f82-8126-0fe683b206a2'}, {'type': 'invoice', 'uuid': '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad'}, {'type': 'invoice', 'uuid': '7704a6b2-ec4d-4dec-8a8e-cb77a0764c3e'}, {'uuid': '9b416e22-9273-499e-97ee-d16fdb4efd84', 'type': 'letter'}, {'type': 'invoice', 'uuid': 'cedbfb0e-3749-4a45-bdd1-c5e7025802d7'}]], 'distances': [[0.0, 0.8120899200439453, 0.8154842257499695, 0.8180853128433228, 0.8256068229675293, 0.8406863808631897, 0.8458439111709595]]}, 'collection': 'smartdoc_classifier_text', 'modality': 'text'}
ğŸ” Debug - Text metadatas length: 7, distances length: 7
ğŸ” Debug - metadata sample: {'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374', 'type': 'invoice'}
ğŸ” Debug - distances: [0.0, 0.8120899200439453, 0.8154842257499695]
ğŸ” Debug - doc_type: invoice, distance: 0.0000
ğŸ” Debug - doc_type: invoice, distance: 0.8121
ğŸ” Debug - doc_type: invoice, distance: 0.8155
ğŸ” Debug - doc_type: invoice, distance: 0.8181
ğŸ” Debug - doc_type: invoice, distance: 0.8256
ğŸ” Debug - doc_type: letter, distance: 0.8407
ğŸ” Debug - doc_type: invoice, distance: 0.8458
ğŸ” Debug - doc_type_scores: {'invoice': 1.8828898072242737, 'letter': 0.1593136191368103}, total_weight: 2.042203426361084
ğŸ“ Text search: invoice (confidence: 0.922)
ğŸ” Debug - About to call image search...
ğŸ” Debug - Starting image search for: /var/folders/qc/_7ltyyj57vb90pr4hx744qy40000gn/T/tmpsr6ajoaz.jpg
âœ… Using MPS (Apple Silicon GPU) for optimal performance
ğŸ¯ Selected device: mps
âœ… OpenCLIP embedding function initialized successfully
âœ… SentenceTransformer embedding function initialized successfully
ğŸ” Debug - Image embedding result: True
ğŸ” Debug - About to query image collection with embedding length: 512
ğŸ” Debug - smartdoc_classifier_images exists: True
ğŸ” Debug - smartdoc_classifier_images count: 3493
ğŸ” Debug - Image query completed, success: True
ğŸ” Debug - Raw image query result: {'success': True, 'results': {'ids': [['6fb5493b-20e8-4d35-ab2b-3b5adfaf5374_img', '1d525c59-9314-46c8-a12a-4acf748b18c7_img', '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad_img']], 'embeddings': None, 'documents': None, 'uris': None, 'included': ['metadatas', 'distances'], 'data': None, 'metadatas': [[{'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374', 'type': 'invoice'}, {'uuid': '1d525c59-9314-46c8-a12a-4acf748b18c7', 'type': 'unknown'}, {'type': 'invoice', 'uuid': '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad'}]], 'distances': [[0.0, 0.20430243015289307, 0.2557361423969269]]}, 'collection': 'smartdoc_classifier_images', 'modality': 'image'}
ğŸ” Debug - Image metadatas length: 3, distances length: 3
ğŸ” Debug - metadata sample: {'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374', 'type': 'invoice'}
ğŸ” Debug - distances: [0.0, 0.20430243015289307, 0.2557361423969269]
ğŸ” Debug - doc_type: invoice, distance: 0.0000
ğŸ” Debug - doc_type: unknown, distance: 0.2043
ğŸ” Debug - doc_type: invoice, distance: 0.2557
ğŸ” Debug - doc_type_scores: {'invoice': 1.7442638576030731}, total_weight: 1.7442638576030731
ğŸ–¼ï¸ Image search: invoice (confidence: 1.000)
ğŸ” Debug - Image search returned: {'classification': 'invoice', 'confidence': 1.0}
ğŸ“Š Analyzing document type with dual confidence...
ğŸ¯ Final: invoice (image wins, confidence: 1.000)
ğŸ¤– Extracting entities using LLM service...
âœ… Analyzed as 'invoice' with 0 entities
.
ğŸ§ª PT-001: Classification Accuracy
  âœ“ ti10161552.jpg â†’ invoice
  âœ“ 513595968.jpg â†’ form
  âœ“ 0001239054.jpg â†’ letter
  âœ“ 0013001762.jpg â†’ memo
âœ… Accuracy: 100.0% (â‰¥70% required)
   Results: 4/4 correct
.
ğŸ§ª UT-001: OCR Text Extraction
Testing: ti10161552.jpg
âœ… Extracted text (confidence: 0.77)
.
ğŸ§ª UT-002: Document Classification
Testing: ti10161552.jpg
âœ… Classified as: invoice (confidence: 0)
.
ğŸ§ª UT-003: Entity Extraction
Testing: ti10161552.jpg
âœ… Extracted 13 entities
.
ğŸ§ª UT-004: API Endpoint Functionality
Testing: ti10161552.jpg
ğŸ” Extracting text using OCR service...
ğŸ” Searching for similar documents in vector database...
ğŸ” Debug - Raw text query result: {'success': True, 'results': {'ids': [['6fb5493b-20e8-4d35-ab2b-3b5adfaf5374_txt', '4fad098c-9d10-4d4d-ba42-dc3a94b82bf8_txt', 'd3baecfd-62d5-4f82-8126-0fe683b206a2_txt', '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad_txt', '7704a6b2-ec4d-4dec-8a8e-cb77a0764c3e_txt', '9b416e22-9273-499e-97ee-d16fdb4efd84_txt', 'cedbfb0e-3749-4a45-bdd1-c5e7025802d7_txt']], 'embeddings': None, 'documents': None, 'uris': None, 'included': ['metadatas', 'distances'], 'data': None, 'metadatas': [[{'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374', 'type': 'invoice'}, {'uuid': '4fad098c-9d10-4d4d-ba42-dc3a94b82bf8', 'type': 'invoice'}, {'uuid': 'd3baecfd-62d5-4f82-8126-0fe683b206a2', 'type': 'invoice'}, {'type': 'invoice', 'uuid': '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad'}, {'uuid': '7704a6b2-ec4d-4dec-8a8e-cb77a0764c3e', 'type': 'invoice'}, {'type': 'letter', 'uuid': '9b416e22-9273-499e-97ee-d16fdb4efd84'}, {'uuid': 'cedbfb0e-3749-4a45-bdd1-c5e7025802d7', 'type': 'invoice'}]], 'distances': [[0.0, 0.8120899200439453, 0.8154842257499695, 0.8180853128433228, 0.8256068229675293, 0.8406863808631897, 0.8458439111709595]]}, 'collection': 'smartdoc_classifier_text', 'modality': 'text'}
ğŸ” Debug - Text metadatas length: 7, distances length: 7
ğŸ” Debug - metadata sample: {'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374', 'type': 'invoice'}
ğŸ” Debug - distances: [0.0, 0.8120899200439453, 0.8154842257499695]
ğŸ” Debug - doc_type: invoice, distance: 0.0000
ğŸ” Debug - doc_type: invoice, distance: 0.8121
ğŸ” Debug - doc_type: invoice, distance: 0.8155
ğŸ” Debug - doc_type: invoice, distance: 0.8181
ğŸ” Debug - doc_type: invoice, distance: 0.8256
ğŸ” Debug - doc_type: letter, distance: 0.8407
ğŸ” Debug - doc_type: invoice, distance: 0.8458
ğŸ” Debug - doc_type_scores: {'invoice': 1.8828898072242737, 'letter': 0.1593136191368103}, total_weight: 2.042203426361084
ğŸ“ Text search: invoice (confidence: 0.922)
ğŸ” Debug - About to call image search...
ğŸ” Debug - Starting image search for: /var/folders/qc/_7ltyyj57vb90pr4hx744qy40000gn/T/tmp2q5qiqu3.jpg
ğŸ” Debug - Image embedding result: True
ğŸ” Debug - About to query image collection with embedding length: 512
ğŸ” Debug - smartdoc_classifier_images exists: True
ğŸ” Debug - smartdoc_classifier_images count: 3493
ğŸ” Debug - Image query completed, success: True
ğŸ” Debug - Raw image query result: {'success': True, 'results': {'ids': [['6fb5493b-20e8-4d35-ab2b-3b5adfaf5374_img', '1d525c59-9314-46c8-a12a-4acf748b18c7_img', '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad_img']], 'embeddings': None, 'documents': None, 'uris': None, 'included': ['metadatas', 'distances'], 'data': None, 'metadatas': [[{'type': 'invoice', 'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374'}, {'type': 'unknown', 'uuid': '1d525c59-9314-46c8-a12a-4acf748b18c7'}, {'uuid': '9efa0828-f5d3-4b29-9b6a-7d64f528a2ad', 'type': 'invoice'}]], 'distances': [[0.0, 0.20430243015289307, 0.2557361423969269]]}, 'collection': 'smartdoc_classifier_images', 'modality': 'image'}
ğŸ” Debug - Image metadatas length: 3, distances length: 3
ğŸ” Debug - metadata sample: {'type': 'invoice', 'uuid': '6fb5493b-20e8-4d35-ab2b-3b5adfaf5374'}
ğŸ” Debug - distances: [0.0, 0.20430243015289307, 0.2557361423969269]
ğŸ” Debug - doc_type: invoice, distance: 0.0000
ğŸ” Debug - doc_type: unknown, distance: 0.2043
ğŸ” Debug - doc_type: invoice, distance: 0.2557
ğŸ” Debug - doc_type_scores: {'invoice': 1.7442638576030731}, total_weight: 1.7442638576030731
ğŸ–¼ï¸ Image search: invoice (confidence: 1.000)
ğŸ” Debug - Image search returned: {'classification': 'invoice', 'confidence': 1.0}
ğŸ“Š Analyzing document type with dual confidence...
ğŸ¯ Final: invoice (image wins, confidence: 1.000)
ğŸ¤– Extracting entities using LLM service...
âœ… API returned: invoice with 0 entities
.
----------------------------------------------------------------------
Ran 6 tests in 17.017s

OK
Destroying test database for alias 'default'...